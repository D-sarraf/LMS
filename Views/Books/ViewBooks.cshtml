@model IEnumerable<LMS.Models.Book>

@{
    ViewData["Title"] = "Books List";
   
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@ViewData["Title"]</h2>

    <a asp-action="Create" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add New Book

    </a>
</div>
<!-- Search Box -->
<form method="get" asp-action="ViewBooks" class="mb-3">
    <div class="input-group">
        <input type="text"
               name="searchString"
               value="@Context.Request.Query["searchString"]"
               class="form-control"
               placeholder="Search by title, author, or ISBN" />
        <button class="btn btn-outline-secondary" type="submit">
            Search
        </button>
    </div>
</form>
<table class="table table-striped btn-outline-light table-hover">
       <thead class="table-dark">
        <tr>
            <th>Cover</th>
            <th>Title</th>
            <th>Author</th>
            <th>Category</th>
            <th>ISBN</th>
            <th>Published Date</th>
            <th>Status</th>
           
            <th style="width:250px;">Actions</th>
        </tr>
       </thead>
  <tbody>
       @if (!Model.Any())
        {
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No books found.
                </td>
            </tr>
        }

        else
        {
            foreach (var book in Model)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrEmpty(book.CoverImagePath))
                        {
                            <img src="@book.CoverImagePath"
                                 alt="cover"
                                 style="height:60px; width:45px; object-fit:cover; border-radius:4px;" />
                        }
                        else
                        {
                            <span class="text-muted small">No cover</span>
                        }
                    </td>

                    <td>@book.Title</td>
                    <td>@book.Author</td>
                    <td>
                        @(book.Category != null ? book.Category.Name : "—")
                    </td>

                    <td>@book.ISBN</td>
                    <td>@book.PublishedDate.ToString("yyyy-MM-dd")</td>
                    <td>
                        @if (book.IsAvailable)
                        {
                            <span class="badge bg-success">Available</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Borrowed</span>
                        }
                        <!-- DEBUG INFO (temporary) -->
                        <div class="text-muted small mt-1">
                            Available: @book.IsAvailable <br />
                            BorrowRecords: @(book.BorrowRecords?.Count ?? 0)
                        </div>
                    </td>
                    <td>
                        <form asp-action="Details"
                              asp-route-id="@book.BookId"
                              method="get"
                              style="display:inline;">

                            @* <div class="btn btn-info btn-sm action-btn text-white"
                                 onclick="this.closest('form').submit();">
                                Details
                            </div> *@
                            <div class="btn btn-info btn-sm rounded-pill px-3 action-btn"
                                 onclick="this.closest('form').submit();">
                                Details
                            </div>
                        </form>

                        <!-- Edit -->
                        <form asp-action="Edit" 
                        asp-route-id="@book.BookId"
                        method="get" style="display:inline;">

                            @* <div class="btn btn-warning btn-sm"
                                 onclick="this.closest('form').submit();">
                                 Edit
                             </div> *@
                            <div class="btn btn-warning btn-sm rounded-pill px-3 action-btn"
                                 onclick="this.closest('form').submit();">
                                Edit
                            </div>
                        </form>

                       

                        <form asp-action="Delete"
                              asp-route-id="@book.BookId"
                              method="post"
                              style="display:inline;"
                              onsubmit="return confirm('Are you sure you want to delete this book?');">

                            @* <div class="btn btn-danger btn-sm"
                                 onclick="this.closest('form').submit();">
                                Delete
                            </div> *@
                            @Html.AntiForgeryToken()
                            <div class="btn btn-danger btn-sm rounded-pill px-3 action-btn"
                                 onclick="this.closest('form').submit();">
                                Delete
                            </div>
                        </form>

                        @if (book.IsAvailable)
                        {
                            <a asp-controller="Borrow"
                               asp-action="Borrowit"
                               asp-route-bookId="@book.BookId"
                               class="btn btn-success btn-sm rounded-pill px-3">
                                Borrow
                            </a>
                        }
                        else
                        {
                            var borrow = book.BorrowRecords?.LastOrDefault(b => b.ReturnDate == null);
                            if (borrow != null)
                            {
                                <a asp-controller="Borrow"
                                      asp-action="Return"
                                      asp-route-id="@borrow.BorrowRecordId"
                                      method="post"
                                      style="display:inline;">
                                    @Html.AntiForgeryToken()
                                    <button class="btn btn-danger btn-sm rounded-pill px-3">Return</button>
                                </a>
                            }
                        }

                        
                        
                    </td> 
                </tr>
            }
        }


  </tbody>
     
</table>
   <style>
       .action-btn {
            opacity: 0.75;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
       }

        .action-btn:hover 
        {
            opacity: 1;
            transform: scale(1.05);
        }
   </style>



<a asp-action="Create" class="btn btn-primary">Add New Book</a>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"></script>
}


